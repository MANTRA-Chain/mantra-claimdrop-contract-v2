# EVM Claimdrop Contract - Build and Deployment Commands
# Uses Foundry (forge) for all operations
#
# Multi-Network Support:
#   - local: Local Anvil node (ChainID: 31337)
#   - dukong: MANTRA DuKong Testnet (ChainID: 5887)
#   - canary: MANTRA Canary Staging Network (ChainID: 7888)
#   - mainnet: MANTRA Mainnet (ChainID: 5888)
#
# Examples:
#   just deploy local          # Deploy to local Anvil
#   just deploy dukong         # Deploy to DuKong testnet
#   just e2e                   # Deploy + run E2E test on DuKong
#   just e2e mainnet           # Deploy + run E2E test on mainnet
#   just networks              # List all available networks

# Default recipe - show available commands
default:
    @just --list

# Build contracts
build:
    @echo "üî® Building contracts..."
    @forge build

# Run tests
test:
    @echo "üß™ Running tests..."
    @forge test

# Run tests without fail-fast (continue on failures)
test-all:
    @echo "üß™ Running all tests..."
    @forge test

# Run tests with gas reporting
test-gas:
    @echo "üìä Running tests with gas reporting..."
    @REPORT_GAS=true forge test --gas-report

# Generate coverage report
coverage:
    @echo "üìà Generating coverage report..."
    @forge coverage

# Format Solidity files
format:
    @echo "‚ú® Formatting Solidity files..."
    @forge fmt

# Check formatting (CI mode)
format-check:
    @echo "‚úÖ Checking Solidity formatting..."
    @forge fmt --check

# Lint contracts with solhint (requires solhint installed globally)
lint:
    @echo "üîç Linting contracts..."
    @solhint 'contracts/**/*.sol' || echo "‚ö†Ô∏è  Install solhint globally: npm install -g solhint"

# Lint shell scripts with ShellCheck
lint-scripts:
    @echo "üîç Linting shell scripts..."
    @command -v shellcheck >/dev/null 2>&1 || { echo "‚ùå shellcheck not installed. Install: brew install shellcheck"; exit 1; }
    @shellcheck scripts/*.sh scripts/lib/*.sh
    @echo "‚úÖ Shell scripts are clean!"

# Clean build artifacts
clean:
    @echo "üßπ Cleaning build artifacts..."
    @forge clean

# =============================================================================
# Multi-Network Helpers (Internal)
# =============================================================================

# Get RPC URL for network
_get-rpc NETWORK:
    #!/usr/bin/env bash
    case "{{NETWORK}}" in
        local)     echo "http://localhost:8545" ;;
        dukong)    echo "${MANTRA_DUKONG_RPC_URL:-https://evm.dukong.mantrachain.io}" ;;
        canary)    echo "${MANTRA_CANARY_RPC_URL:-https://evm.canary.mantrachain.dev}" ;;
        mainnet)   echo "${MANTRA_MAINNET_RPC_URL:-https://evm.mantrachain.io}" ;;
        *)         echo "‚ùå Unknown network: {{NETWORK}}" >&2
                   echo "Run 'just networks' to see available networks" >&2
                   exit 1 ;;
    esac

# Validate network is configured
_validate-network NETWORK:
    #!/usr/bin/env bash
    RPC=$(just _get-rpc {{NETWORK}} 2>/dev/null) || exit 1
    if [ -z "$RPC" ]; then
        echo "‚ùå Network '{{NETWORK}}' RPC URL not configured"
        exit 1
    fi

# Check if PRIVATE_KEY is set (required for broadcasting)
_check-private-key:
    #!/usr/bin/env bash
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        echo "Set PRIVATE_KEY in your .env file or environment"
        exit 1
    fi

# =============================================================================
# Network Information
# =============================================================================

# List available networks
networks:
    @echo "üì° Available Networks:"
    @echo ""
    @echo "  local    - Local Anvil Node"
    @echo "             ChainID: 31337"
    @echo "             RPC: http://localhost:8545"
    @echo "             Usage: Development and rapid testing"
    @echo ""
    @echo "  dukong   - MANTRA DuKong Testnet"
    @echo "             ChainID: 5887"
    @echo "             RPC: https://evm.dukong.mantrachain.io"
    @echo "             Explorer: https://mantrascan.io/dukong"
    @echo "             Faucet: https://faucet.dukong.mantrachain.io"
    @echo "             Usage: Primary testnet for realistic E2E testing"
    @echo ""
    @echo "  canary   - MANTRA Canary Staging Network"
    @echo "             ChainID: 7888"
    @echo "             RPC: https://evm.canary.mantrachain.dev"
    @echo "             Usage: Pre-production validation before mainnet"
    @echo ""
    @echo "  mainnet  - MANTRA Mainnet"
    @echo "             ChainID: 5888"
    @echo "             RPC: https://evm.mantrachain.io"
    @echo "             Explorer: https://mantrascan.io"
    @echo "             Usage: Production (fork testing only)"
    @echo ""
    @echo "Examples:"
    @echo "  just deploy local          # Deploy to local Anvil"
    @echo "  just deploy dukong         # Deploy to DuKong testnet"
    @echo "  just create-campaign canary   # Create campaign on Canary"
    @echo ""

# =============================================================================
# Unified Multi-Network Commands
# =============================================================================

# Deploy Claimdrop contract to specified network
deploy NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    # Mainnet safety check
    if [ "{{NETWORK}}" = "mainnet" ]; then
        echo "‚ö†Ô∏è  Deploying to MAINNET - please confirm"
        read -p "Continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Deployment cancelled"
            exit 1
        fi
    fi

    # Local network doesn't need PRIVATE_KEY (uses default Anvil account)
    if [ "{{NETWORK}}" != "local" ]; then
        just _check-private-key
    fi

    echo "üöÄ Deploying to {{NETWORK}}..."
    NETWORK={{NETWORK}} forge script script/Deploy.s.sol:Deploy \
        --rpc-url $RPC \
        --broadcast
    echo "‚úÖ Deployment complete!"

# Legacy aliases (backward compatibility)
deploy-local: (deploy "local")
deploy-testnet: (deploy "dukong")
deploy-mainnet: (deploy "mainnet")

# Deploy upgradeable ClaimdropFactory to local Anvil node
deploy-factory-local:
    @echo "üè≠ Deploying ClaimdropFactory (upgradeable) to local Anvil..."
    @forge script script/DeployFactory.s.sol:DeployFactory --rpc-url http://localhost:8545 --broadcast

# Deploy upgradeable ClaimdropFactory to MANTRA Dukong testnet
deploy-factory-testnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "üè≠ Deploying ClaimdropFactory (upgradeable) to MANTRA Dukong testnet..."
    forge script script/DeployFactory.s.sol:DeployFactory \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory deployment complete!"
    echo "üìù Save the ProxyAdmin and Proxy addresses for future upgrades!"

# Deploy upgradeable ClaimdropFactory to MANTRA mainnet
deploy-factory-mainnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Deploying ClaimdropFactory to MAINNET - please confirm"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deployment cancelled"
        exit 1
    fi
    echo "üè≠ Deploying ClaimdropFactory (upgradeable) to MANTRA mainnet..."
    forge script script/DeployFactory.s.sol:DeployFactory \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory deployment complete!"
    echo "üìù Save the ProxyAdmin and Proxy addresses for future upgrades!"

# Upgrade ClaimdropFactory on MANTRA Dukong testnet
upgrade-factory-testnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${PROXY_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADDRESS not set"
        exit 1
    fi
    if [ -z "${PROXY_ADMIN_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADMIN_ADDRESS not set"
        exit 1
    fi
    echo "üîÑ Upgrading ClaimdropFactory on MANTRA Dukong testnet..."
    echo "   Proxy: $PROXY_ADDRESS"
    echo "   ProxyAdmin: $PROXY_ADMIN_ADDRESS"
    forge script script/UpgradeFactory.s.sol:UpgradeFactory \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory upgrade complete!"

# Upgrade ClaimdropFactory on MANTRA mainnet
upgrade-factory-mainnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${PROXY_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADDRESS not set"
        exit 1
    fi
    if [ -z "${PROXY_ADMIN_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADMIN_ADDRESS not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Upgrading ClaimdropFactory on MAINNET - please confirm"
    echo "   Proxy: $PROXY_ADDRESS"
    echo "   ProxyAdmin: $PROXY_ADMIN_ADDRESS"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Upgrade cancelled"
        exit 1
    fi
    echo "üîÑ Upgrading ClaimdropFactory on MANTRA mainnet..."
    forge script script/UpgradeFactory.s.sol:UpgradeFactory \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory upgrade complete!"

# Verify contract on block explorer
verify CONTRACT_ADDRESS CHAIN="mantradukong":
    #!/usr/bin/env bash
    set -euo pipefail
    if [ "{{CHAIN}}" = "mantradukong" ]; then
        VERIFIER_URL="https://evm.dukong.mantrachain.io/api"
    else
        VERIFIER_URL="https://evm.mantrachain.io/api"
    fi
    echo "üîç Verifying contract on {{CHAIN}}..."
    forge verify-contract {{CONTRACT_ADDRESS}} \
        contracts/Claimdrop.sol:Claimdrop \
        --verifier-url $VERIFIER_URL \
        --watch
    echo "‚úÖ Verification complete!"

# Run CI pipeline (format-check + lint + lint-scripts + test-all)
ci:
    @echo "üöÄ Running CI pipeline..."
    @just format-check
    @just lint-scripts
    @just test-all
    @echo "‚úÖ CI pipeline complete!"

# =============================================================================
# E2E Testing (Fast, Local)
# =============================================================================

# Run E2E test contract (fast, local only)
e2e-test:
    @echo "üß™ Running E2E tests..."
    @forge test --match-contract E2EClaimdrop -vv
    @echo "‚úÖ E2E tests complete!"

# Run E2E tests on forked network (read-only, no gas cost)
e2e-fork NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    echo "üî± Running E2E tests on {{NETWORK}} fork..."
    echo "This is read-only and will not broadcast transactions"
    echo ""
    forge test --match-contract E2EClaimdrop \
        --fork-url $RPC \
        -vv
    echo ""
    echo "‚úÖ Fork tests complete!"

# =============================================================================
# Pure Cast E2E Integration Testing (Cosmos SDK EVM Compatible)
# =============================================================================
#
# Pure bash+just+cast orchestration for testnet integration testing.
# No forge scripts in critical path - all transactions use cast send.
#
# Architecture:
# - `cast send --create` for contract deployment
# - `cast send` with inline ABI encoding for all contract interactions
# - deployments.txt for state persistence across phases
#
# Benefits:
# - Cosmos SDK EVM compatible (sequential transactions)
# - Easy debugging (transparent bash orchestration)
# - No temporary file pollution
# - Complex struct arrays handled natively by modern cast
#
# Usage:
#   just e2e                        # Deploy + run comprehensive E2E test on dukong
#   just e2e mainnet                # Deploy + run comprehensive E2E test on mainnet
#   just e2e-deploy                 # Deploy contracts only (use with individual phases)
#   just e2e-setup                  # Create campaign and allocations (pure cast)
#   just e2e-execute                # Execute test claims (pure cast)
#   just e2e-close                  # Close campaign (pure cast)
#   just e2e-basic                  # Run 4 basic phases with dummy addresses
#

# Main entry point: Comprehensive E2E test (always deploys fresh contracts)
# Usage:
#   just e2e              - Deploy + run E2E test on dukong (default)
#   just e2e mainnet      - Deploy + run E2E test on mainnet
#
# Note: This test ALWAYS deploys fresh contracts because:
# - It generates new temporary test addresses
# - The Claimdrop contract only allows ONE campaign per deployment
# - Therefore, each test run needs fresh contracts
e2e network="dukong":
    #!/usr/bin/env bash
    set -e

    echo ""
    echo "=========================================="
    echo "  Comprehensive E2E Test"
    echo "  Network: {{network}}"
    echo "=========================================="
    echo ""

    # Load environment first
    if [ ! -f .env ]; then
        echo "‚ùå Error: .env file not found"
        echo "Copy .env.example to .env and configure"
        exit 1
    fi

    set -a
    source .env
    set +a

    # Validate network and set RPC_URL
    case "{{network}}" in
        dukong|testnet)
            export RPC_URL="${MANTRA_DUKONG_RPC_URL:?MANTRA_DUKONG_RPC_URL not set in .env}"
            echo "‚úì Using DuKong testnet"
            ;;
        mainnet)
            export RPC_URL="${MANTRA_MAINNET_RPC_URL:?MANTRA_MAINNET_RPC_URL not set in .env}"
            echo "‚úì Using MANTRA mainnet"
            echo "‚ö†Ô∏è  WARNING: Running on mainnet!"
            read -p "Are you sure? (yes/no): " confirm
            if [ "$confirm" != "yes" ]; then
                echo "Aborted."
                exit 1
            fi
            ;;
        *)
            echo "‚ùå Unknown network: {{network}}"
            echo "Valid networks: dukong, testnet, mainnet"
            exit 1
            ;;
    esac

    # Validate required vars
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set in .env"
        exit 1
    fi

    echo ""
    echo "Running comprehensive E2E workflow..."
    echo "(Deploys fresh contracts + creates funded test addresses)"
    echo ""

    # Deploy fresh contracts
    just e2e-deploy

    # Run comprehensive E2E test with funded addresses
    echo ""
    echo "üöÄ Running comprehensive E2E test..."
    echo ""
    ./scripts/cast-e2e-complete.sh

    echo ""
    echo "=========================================="
    echo "  ‚úÖ E2E Test Complete"
    echo "  Network: {{network}}"
    echo "=========================================="
    echo ""

# Phase 1: Deploy contracts using cast send (sequential, nonce-managed)
e2e-deploy:
    #!/usr/bin/env bash
    set -e

    # Load environment from .env if it exists
    if [ -f .env ]; then
        set -a
        source .env
        set +a
    fi

    # Validate environment
    if [ -z "${RPC_URL:-}" ]; then
        echo "‚ùå Error: RPC_URL not set"
        echo "Set RPC_URL in .env or environment"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        echo "Set PRIVATE_KEY in .env or environment"
        exit 1
    fi

    echo ""
    echo "üöÄ Phase 1: Deploy contracts using cast send..."
    echo ""

    # Run cast-based deployment
    GAS_PRICE="${GAS_PRICE:-50000000000}"
    export RPC_URL PRIVATE_KEY GAS_PRICE
    ./scripts/cast-deploy.sh

    echo ""
    echo "‚úÖ Phase 1 Complete!"

# Phase 2: Setup campaign and add allocations (pure cast)
e2e-setup:
    #!/usr/bin/env bash
    set -e

    # Check deployments.txt exists
    if [ ! -f deployments.txt ]; then
        echo "‚ùå Error: deployments.txt not found"
        echo "Run 'just e2e-deploy' first"
        exit 1
    fi

    echo ""
    echo "üìã Phase 2: Setup campaign and add allocations..."
    echo ""

    # Load .env first, then deployment state (skip comment lines)
    if [ -f .env ]; then
        set -a
        source .env
        set +a
    fi
    export $(grep -v '^#' deployments.txt | xargs)

    # Validate environment
    if [ -z "${RPC_URL:-}" ]; then
        echo "‚ùå Error: RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${CLAIMDROP:-}" ]; then
        echo "‚ùå Error: CLAIMDROP address not found in deployments.txt"
        exit 1
    fi

    # Run pure cast setup script (no forge scripts, pure cast send)
    ./scripts/cast-setup.sh

    echo ""
    echo "‚úÖ Phase 2 Complete!"

# Phase 3: Execute test claims
e2e-execute:
    #!/usr/bin/env bash
    set -e

    # Check deployments.txt exists
    if [ ! -f deployments.txt ]; then
        echo "‚ùå Error: deployments.txt not found"
        echo "Run 'just e2e-deploy' first"
        exit 1
    fi

    echo ""
    echo "üí∞ Phase 3: Execute test claims..."
    echo ""

    # Load .env first, then deployment state (skip comment lines)
    if [ -f .env ]; then
        set -a
        source .env
        set +a
    fi
    export $(grep -v '^#' deployments.txt | xargs)

    # Validate environment
    if [ -z "${RPC_URL:-}" ]; then
        echo "‚ùå Error: RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${CLAIMDROP:-}" ]; then
        echo "‚ùå Error: CLAIMDROP address not found in deployments.txt"
        exit 1
    fi

    # Run pure cast claims execution script
    ./scripts/cast-execute-claims.sh

    echo ""
    echo "‚úÖ Phase 3 Complete!"

# Phase 4: Close campaign
e2e-close:
    #!/usr/bin/env bash
    set -e

    # Check deployments.txt exists
    if [ ! -f deployments.txt ]; then
        echo "‚ùå Error: deployments.txt not found"
        echo "Run 'just e2e-deploy' first"
        exit 1
    fi

    echo ""
    echo "üèÅ Phase 4: Close campaign..."
    echo ""

    # Load .env first, then deployment state (skip comment lines)
    if [ -f .env ]; then
        set -a
        source .env
        set +a
    fi
    export $(grep -v '^#' deployments.txt | xargs)

    # Validate environment
    if [ -z "${RPC_URL:-}" ]; then
        echo "‚ùå Error: RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${CLAIMDROP:-}" ]; then
        echo "‚ùå Error: CLAIMDROP address not found in deployments.txt"
        exit 1
    fi

    # Run pure cast close campaign script
    ./scripts/cast-close-campaign.sh

    echo ""
    echo "‚úÖ Phase 4 Complete!"

# Basic E2E flow: Deploy ‚Üí Setup ‚Üí Execute ‚Üí Close (with dummy addresses)
e2e-basic:
    #!/usr/bin/env bash
    set -e

    echo ""
    echo "=========================================="
    echo "  Basic E2E Integration Test Suite"
    echo "=========================================="
    echo ""
    echo "This runs all 4 phases of the E2E workflow:"
    echo "  1. Deploy contracts (cast send)"
    echo "  2. Setup campaign (pure cast send)"
    echo "  3. Execute claims (pure cast send)"
    echo "  4. Close campaign (pure cast send)"
    echo ""

    just e2e-deploy
    just e2e-setup
    just e2e-execute
    just e2e-close

    echo ""
    echo "=========================================="
    echo "  ‚úÖ E2E Test Complete!"
    echo "=========================================="
    echo ""
    echo "Test completed successfully!"
    echo "Contract addresses saved in: deployments.txt"
    echo ""

# Generate formatted report from e2e-report.txt with Mantrascan links
e2e-report:
    #!/usr/bin/env bash
    set -e

    REPORT_FILE="e2e-report.txt"

    if [ ! -f "$REPORT_FILE" ]; then
        echo "‚ùå Error: $REPORT_FILE not found"
        echo ""
        echo "Run 'just e2e' first to generate the report"
        exit 1
    fi

    echo ""
    echo "=========================================="
    echo "  E2E Test Transaction Report"
    echo "=========================================="
    echo ""

    # Determine network from RPC URL
    NETWORK_LINE=$(grep "^NETWORK|" "$REPORT_FILE" | cut -d'|' -f2)
    EXPLORER_BASE=""
    NETWORK_NAME=""

    if [[ "$NETWORK_LINE" == *"dukong"* ]]; then
        EXPLORER_BASE="https://mantrascan.io/dukong/tx"
        NETWORK_NAME="DuKong Testnet"
    elif [[ "$NETWORK_LINE" == *"mantrachain.io"* ]]; then
        EXPLORER_BASE="https://www.mantrascan.io/tx"
        NETWORK_NAME="MANTRA Mainnet"
    else
        EXPLORER_BASE="https://mantrascan.io/dukong/tx"
        NETWORK_NAME="Unknown Network"
    fi

    echo "Network: $NETWORK_NAME"
    echo ""

    # Show contract addresses
    echo "üìù Deployed Contracts:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    DEPLOYER=$(grep "^DEPLOYER|" "$REPORT_FILE" | cut -d'|' -f2)
    CLAIMDROP=$(grep "^CLAIMDROP|" "$REPORT_FILE" | cut -d'|' -f2)
    MOCKERC20=$(grep "^MOCKERC20|" "$REPORT_FILE" | cut -d'|' -f2)
    echo "Deployer:  $DEPLOYER"
    echo "Claimdrop: $CLAIMDROP"
    echo "MockERC20: $MOCKERC20"
    echo ""

    # Show transactions
    echo "üìä Transactions:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

    # Read and format transactions
    while IFS='|' read -r label tx_hash; do
        # Skip metadata lines
        if [[ "$label" == "NETWORK" ]] || [[ "$label" == "DEPLOYER" ]] || \
           [[ "$label" == "CLAIMDROP" ]] || [[ "$label" == "MOCKERC20" ]] || \
           [[ "$label" == "SEPARATOR" ]]; then
            continue
        fi

        if [ -n "$tx_hash" ]; then
            echo ""
            echo "‚úì $label"
            echo "  TX: $tx_hash"
            echo "  üîó $EXPLORER_BASE/$tx_hash"
        fi
    done < "$REPORT_FILE"

    echo ""
    echo "=========================================="
    echo ""
    echo "Report file: $REPORT_FILE"
    echo ""

# Show E2E help
e2e-help:
    @echo "Pure Cast E2E Integration Testing"
    @echo ""
    @echo "Main Command:"
    @echo "  just e2e                 - Deploy + run comprehensive E2E test on dukong"
    @echo "  just e2e mainnet         - Deploy + run comprehensive E2E test on mainnet"
    @echo ""
    @echo "What it does:"
    @echo "  - Deploys fresh contracts (MockERC20 + Claimdrop)"
    @echo "  - Generates 3 temporary test addresses"
    @echo "  - Funds them with OM for gas"
    @echo "  - Creates campaign and adds allocations"
    @echo "  - Executes claims from test users"
    @echo "  - Verifies balances"
    @echo "  - Sweeps remaining OM back to deployer"
    @echo ""
    @echo "Report:"
    @echo "  just e2e-report          - View formatted transaction report with Mantrascan links"
    @echo ""
    @echo "Individual Phase Commands (for manual workflows):"
    @echo "  just e2e-deploy          - Deploy contracts using cast send"
    @echo "  just e2e-setup           - Create campaign and allocations"
    @echo "  just e2e-execute         - Execute test claims"
    @echo "  just e2e-close           - Close campaign"
    @echo "  just e2e-basic           - Run 4 basic phases with dummy addresses"
    @echo ""
    @echo "Quick Start:"
    @echo "  1. Copy .env.example to .env and configure"
    @echo "  2. Run: just e2e"
    @echo "  3. Monitor: cat deployments.txt"
    @echo ""
    @echo "Architecture (Pure Foundry Toolchain):"
    @echo "  - Phase 1: cast send --create (deploy contracts)"
    @echo "  - Phase 2: cast send with complex ABI encoding (campaign + allocations)"
    @echo "  - Phase 3: cast send (claim execution)"
    @echo "  - Phase 4: cast send (campaign closure)"
    @echo ""
    @echo "Benefits:"
    @echo "  ‚úì Pure bash + cast tooling (no forge scripts in critical path)"
    @echo "  ‚úì Cosmos SDK EVM compatible (sequential transactions)"
    @echo "  ‚úì Easy to debug (transparent bash orchestration)"
    @echo "  ‚úì No temporary file pollution"
    @echo ""
    @echo "State Persistence:"
    @echo "  - deployments.txt: Shared state across all phases"
    @echo "  - Automatic timestamp recalculation for campaign start/end"
    @echo ""
