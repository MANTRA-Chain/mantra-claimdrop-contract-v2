# EVM Claimdrop Contract - Build and Deployment Commands
# Uses Foundry (forge) for all operations
#
# Multi-Network Support:
#   - local: Local Anvil node (ChainID: 31337)
#   - dukong: MANTRA DuKong Testnet (ChainID: 5887)
#   - canary: MANTRA Canary Staging Network (ChainID: 7888)
#   - mainnet: MANTRA Mainnet (ChainID: 5888)
#
# Examples:
#   just deploy local          # Deploy to local Anvil
#   just deploy dukong         # Deploy to DuKong testnet
#   just e2e dukong            # Run full E2E suite on DuKong
#   just networks              # List all available networks

# Default recipe - show available commands
default:
    @just --list

# Build contracts
build:
    @echo "üî® Building contracts..."
    @forge build

# Run tests
test:
    @echo "üß™ Running tests..."
    @forge test

# Run tests without fail-fast (continue on failures)
test-all:
    @echo "üß™ Running all tests..."
    @forge test

# Run tests with gas reporting
test-gas:
    @echo "üìä Running tests with gas reporting..."
    @REPORT_GAS=true forge test --gas-report

# Generate coverage report
coverage:
    @echo "üìà Generating coverage report..."
    @forge coverage

# Format Solidity files
format:
    @echo "‚ú® Formatting Solidity files..."
    @forge fmt

# Check formatting (CI mode)
format-check:
    @echo "‚úÖ Checking Solidity formatting..."
    @forge fmt --check

# Lint contracts with solhint (requires solhint installed globally)
lint:
    @echo "üîç Linting contracts..."
    @solhint 'contracts/**/*.sol' || echo "‚ö†Ô∏è  Install solhint globally: npm install -g solhint"

# Clean build artifacts
clean:
    @echo "üßπ Cleaning build artifacts..."
    @forge clean

# =============================================================================
# Multi-Network Helpers (Internal)
# =============================================================================

# Get RPC URL for network
_get-rpc NETWORK:
    #!/usr/bin/env bash
    case "{{NETWORK}}" in
        local)     echo "http://localhost:8545" ;;
        dukong)    echo "${MANTRA_DUKONG_RPC_URL:-https://evm.dukong.mantrachain.io}" ;;
        canary)    echo "${MANTRA_CANARY_RPC_URL:-https://evm.canary.mantrachain.dev}" ;;
        mainnet)   echo "${MANTRA_MAINNET_RPC_URL:-https://evm.mantrachain.io}" ;;
        *)         echo "‚ùå Unknown network: {{NETWORK}}" >&2
                   echo "Run 'just networks' to see available networks" >&2
                   exit 1 ;;
    esac

# Validate network is configured
_validate-network NETWORK:
    #!/usr/bin/env bash
    RPC=$(just _get-rpc {{NETWORK}} 2>/dev/null) || exit 1
    if [ -z "$RPC" ]; then
        echo "‚ùå Network '{{NETWORK}}' RPC URL not configured"
        exit 1
    fi

# Check if PRIVATE_KEY is set (required for broadcasting)
_check-private-key:
    #!/usr/bin/env bash
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        echo "Set PRIVATE_KEY in your .env file or environment"
        exit 1
    fi

# =============================================================================
# Network Information
# =============================================================================

# List available networks
networks:
    @echo "üì° Available Networks:"
    @echo ""
    @echo "  local    - Local Anvil Node"
    @echo "             ChainID: 31337"
    @echo "             RPC: http://localhost:8545"
    @echo "             Usage: Development and rapid testing"
    @echo ""
    @echo "  dukong   - MANTRA DuKong Testnet"
    @echo "             ChainID: 5887"
    @echo "             RPC: https://evm.dukong.mantrachain.io"
    @echo "             Explorer: https://mantrascan.io/dukong"
    @echo "             Faucet: https://faucet.dukong.mantrachain.io"
    @echo "             Usage: Primary testnet for realistic E2E testing"
    @echo ""
    @echo "  canary   - MANTRA Canary Staging Network"
    @echo "             ChainID: 7888"
    @echo "             RPC: https://evm.canary.mantrachain.dev"
    @echo "             Usage: Pre-production validation before mainnet"
    @echo ""
    @echo "  mainnet  - MANTRA Mainnet"
    @echo "             ChainID: 5888"
    @echo "             RPC: https://evm.mantrachain.io"
    @echo "             Explorer: https://mantrascan.io"
    @echo "             Usage: Production (fork testing only)"
    @echo ""
    @echo "Examples:"
    @echo "  just deploy local          # Deploy to local Anvil"
    @echo "  just deploy dukong         # Deploy to DuKong testnet"
    @echo "  just create-campaign canary   # Create campaign on Canary"
    @echo ""

# =============================================================================
# Unified Multi-Network Commands
# =============================================================================

# Deploy Claimdrop contract to specified network
deploy NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    # Mainnet safety check
    if [ "{{NETWORK}}" = "mainnet" ]; then
        echo "‚ö†Ô∏è  Deploying to MAINNET - please confirm"
        read -p "Continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Deployment cancelled"
            exit 1
        fi
    fi

    # Local network doesn't need PRIVATE_KEY (uses default Anvil account)
    if [ "{{NETWORK}}" != "local" ]; then
        just _check-private-key
    fi

    echo "üöÄ Deploying to {{NETWORK}}..."
    NETWORK={{NETWORK}} forge script script/Deploy.s.sol:Deploy \
        --rpc-url $RPC \
        --broadcast
    echo "‚úÖ Deployment complete!"

# Legacy aliases (backward compatibility)
deploy-local: (deploy "local")
deploy-testnet: (deploy "dukong")
deploy-mainnet: (deploy "mainnet")

# Deploy upgradeable ClaimdropFactory to local Anvil node
deploy-factory-local:
    @echo "üè≠ Deploying ClaimdropFactory (upgradeable) to local Anvil..."
    @forge script script/DeployFactory.s.sol:DeployFactory --rpc-url http://localhost:8545 --broadcast

# Deploy upgradeable ClaimdropFactory to MANTRA Dukong testnet
deploy-factory-testnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "üè≠ Deploying ClaimdropFactory (upgradeable) to MANTRA Dukong testnet..."
    forge script script/DeployFactory.s.sol:DeployFactory \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory deployment complete!"
    echo "üìù Save the ProxyAdmin and Proxy addresses for future upgrades!"

# Deploy upgradeable ClaimdropFactory to MANTRA mainnet
deploy-factory-mainnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Deploying ClaimdropFactory to MAINNET - please confirm"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deployment cancelled"
        exit 1
    fi
    echo "üè≠ Deploying ClaimdropFactory (upgradeable) to MANTRA mainnet..."
    forge script script/DeployFactory.s.sol:DeployFactory \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory deployment complete!"
    echo "üìù Save the ProxyAdmin and Proxy addresses for future upgrades!"

# Upgrade ClaimdropFactory on MANTRA Dukong testnet
upgrade-factory-testnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${PROXY_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADDRESS not set"
        exit 1
    fi
    if [ -z "${PROXY_ADMIN_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADMIN_ADDRESS not set"
        exit 1
    fi
    echo "üîÑ Upgrading ClaimdropFactory on MANTRA Dukong testnet..."
    echo "   Proxy: $PROXY_ADDRESS"
    echo "   ProxyAdmin: $PROXY_ADMIN_ADDRESS"
    forge script script/UpgradeFactory.s.sol:UpgradeFactory \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory upgrade complete!"

# Upgrade ClaimdropFactory on MANTRA mainnet
upgrade-factory-mainnet:
    #!/usr/bin/env bash
    source .env
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    if [ -z "${PROXY_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADDRESS not set"
        exit 1
    fi
    if [ -z "${PROXY_ADMIN_ADDRESS:-}" ]; then
        echo "‚ùå Error: PROXY_ADMIN_ADDRESS not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Upgrading ClaimdropFactory on MAINNET - please confirm"
    echo "   Proxy: $PROXY_ADDRESS"
    echo "   ProxyAdmin: $PROXY_ADMIN_ADDRESS"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Upgrade cancelled"
        exit 1
    fi
    echo "üîÑ Upgrading ClaimdropFactory on MANTRA mainnet..."
    forge script script/UpgradeFactory.s.sol:UpgradeFactory \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Factory upgrade complete!"

# Verify contract on block explorer
verify CONTRACT_ADDRESS CHAIN="mantradukong":
    #!/usr/bin/env bash
    set -euo pipefail
    if [ "{{CHAIN}}" = "mantradukong" ]; then
        VERIFIER_URL="https://evm.dukong.mantrachain.io/api"
    else
        VERIFIER_URL="https://evm.mantrachain.io/api"
    fi
    echo "üîç Verifying contract on {{CHAIN}}..."
    forge verify-contract {{CONTRACT_ADDRESS}} \
        contracts/Claimdrop.sol:Claimdrop \
        --verifier-url $VERIFIER_URL \
        --watch
    echo "‚úÖ Verification complete!"

# Create campaign on specified network
create-campaign NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    # Mainnet safety check
    if [ "{{NETWORK}}" = "mainnet" ]; then
        echo "‚ö†Ô∏è  Creating campaign on MAINNET - please confirm"
        read -p "Continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Campaign creation cancelled"
            exit 1
        fi
    fi

    # Local network doesn't need PRIVATE_KEY
    if [ "{{NETWORK}}" != "local" ]; then
        just _check-private-key
    fi

    echo "üìã Creating campaign on {{NETWORK}}..."
    NETWORK={{NETWORK}} forge script script/CreateCampaign.s.sol:CreateCampaign \
        --rpc-url $RPC \
        --broadcast
    echo "‚úÖ Campaign created!"

# Legacy aliases
create-campaign-local: (create-campaign "local")
create-campaign-testnet: (create-campaign "dukong")
create-campaign-mainnet: (create-campaign "mainnet")

# Upload allocations to specified network
upload-allocations NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    # Mainnet safety check
    if [ "{{NETWORK}}" = "mainnet" ]; then
        echo "‚ö†Ô∏è  Uploading allocations to MAINNET - please confirm"
        read -p "Continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Allocation upload cancelled"
            exit 1
        fi
    fi

    # Local network doesn't need PRIVATE_KEY
    if [ "{{NETWORK}}" != "local" ]; then
        just _check-private-key
    fi

    echo "üì§ Uploading allocations to {{NETWORK}}..."
    NETWORK={{NETWORK}} forge script script/UploadAllocations.s.sol:UploadAllocations \
        --rpc-url $RPC \
        --broadcast
    echo "‚úÖ Allocations uploaded!"

# Legacy aliases
upload-allocations-local: (upload-allocations "local")
upload-allocations-testnet: (upload-allocations "dukong")
upload-allocations-mainnet: (upload-allocations "mainnet")

# Run CI pipeline (format-check + lint + test-all)
ci:
    @echo "üöÄ Running CI pipeline..."
    @just format-check
    @just test-all
    @echo "‚úÖ CI pipeline complete!"

# =============================================================================
# E2E Orchestration Commands
# =============================================================================

# Run full E2E orchestration on specified network
e2e NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    # Mainnet safety check
    if [ "{{NETWORK}}" = "mainnet" ]; then
        echo "‚ö†Ô∏è  Running E2E on MAINNET fork only (read-only)"
        echo "This will NOT broadcast transactions"
    fi

    # Local network doesn't need PRIVATE_KEY
    if [ "{{NETWORK}}" != "local" ]; then
        just _check-private-key
    fi

    echo "üöÄ Running E2E orchestration on {{NETWORK}}..."
    echo ""
    NETWORK={{NETWORK}} forge script script/e2e/E2EOrchestrator.s.sol:E2EOrchestrator \
        --rpc-url $RPC \
        --broadcast \
        -vv
    echo ""
    echo "‚úÖ E2E orchestration complete!"
    echo "üìä Check report: out/e2e-report-{{NETWORK}}-*.md"
    echo "üíæ State saved: out/e2e-state-{{NETWORK}}.json"

# Run E2E test contract (fast, local only)
e2e-test:
    @echo "üß™ Running E2E tests..."
    @forge test --match-contract E2EClaimdrop -vv
    @echo "‚úÖ E2E tests complete!"

# Run E2E tests on forked network (read-only, no gas cost)
e2e-fork NETWORK:
    #!/usr/bin/env bash
    set -euo pipefail
    just _validate-network {{NETWORK}}
    RPC=$(just _get-rpc {{NETWORK}})

    echo "üî± Running E2E tests on {{NETWORK}} fork..."
    echo "This is read-only and will not broadcast transactions"
    echo ""
    forge test --match-contract E2EClaimdrop \
        --fork-url $RPC \
        -vv
    echo ""
    echo "‚úÖ Fork tests complete!"

# Legacy alias for e2e
e2e-local: (e2e "local")
e2e-testnet: (e2e "dukong")

# Show E2E help and examples
e2e-help:
    @echo "E2E Orchestration Commands"
    @echo ""
    @echo "Commands:"
    @echo "  just e2e <network>       - Run complete E2E lifecycle on network"
    @echo "  just e2e-test            - Run E2E tests locally (fast)"
    @echo "  just e2e-fork <network>  - Run E2E tests on forked network (read-only)"
    @echo ""
    @echo "Examples:"
    @echo "  just e2e local           - Complete E2E on local Anvil (1-2 min)"
    @echo "  just e2e dukong          - Complete E2E on DuKong testnet (1-2 hrs)"
    @echo "  just e2e-test            - Fast E2E tests (< 30 sec)"
    @echo "  just e2e-fork dukong     - Fork test on DuKong (no gas cost)"
    @echo ""
    @echo "What E2E Does:"
    @echo "  1. ‚úÖ Deploy Claimdrop contract"
    @echo "  2. ‚úÖ Create campaign with network-appropriate timing"
    @echo "  3. ‚úÖ Upload test allocations (10 users)"
    @echo "  4. ‚úÖ Wait for campaign start"
    @echo "  5. ‚úÖ Execute test claims"
    @echo "  6. ‚úÖ Close campaign"
    @echo "  7. ‚úÖ Validate all state"
    @echo "  8. ‚úÖ Generate report"
    @echo ""
    @echo "Output Files:"
    @echo "  - out/e2e-state-{network}.json       - Execution state"
    @echo "  - out/e2e-report-{network}-*.md      - Detailed report"
    @echo ""
    @echo "For more details, see README-MULTINETWORK.md"
