# EVM Claimdrop Contract - Build and Deployment Commands
# Uses Foundry (forge) for all operations

# Default recipe - show available commands
default:
    @just --list

# Build contracts
build:
    @echo "üî® Building contracts..."
    @forge build

# Run tests
test:
    @echo "üß™ Running tests..."
    @forge test

# Run tests without fail-fast (continue on failures)
test-all:
    @echo "üß™ Running all tests..."
    @forge test

# Run tests with gas reporting
test-gas:
    @echo "üìä Running tests with gas reporting..."
    @REPORT_GAS=true forge test --gas-report

# Generate coverage report
coverage:
    @echo "üìà Generating coverage report..."
    @forge coverage

# Format Solidity files
format:
    @echo "‚ú® Formatting Solidity files..."
    @forge fmt

# Check formatting (CI mode)
format-check:
    @echo "‚úÖ Checking Solidity formatting..."
    @forge fmt --check

# Lint contracts with solhint (requires solhint installed globally)
lint:
    @echo "üîç Linting contracts..."
    @solhint 'contracts/**/*.sol' || echo "‚ö†Ô∏è  Install solhint globally: npm install -g solhint"

# Clean build artifacts
clean:
    @echo "üßπ Cleaning build artifacts..."
    @forge clean

# Deploy to local Anvil node
deploy-local:
    @echo "üöÄ Deploying to local Anvil..."
    @forge script script/Deploy.s.sol:Deploy --rpc-url http://localhost:8545 --broadcast

# Deploy to MANTRA Dukong testnet
deploy-testnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "üöÄ Deploying to MANTRA Dukong testnet..."
    forge script script/Deploy.s.sol:Deploy \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Deployment complete!"

# Deploy to MANTRA mainnet
deploy-mainnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Deploying to MAINNET - please confirm"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deployment cancelled"
        exit 1
    fi
    echo "üöÄ Deploying to MANTRA mainnet..."
    forge script script/Deploy.s.sol:Deploy \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Deployment complete!"

# Verify contract on block explorer
verify CONTRACT_ADDRESS CHAIN="mantradukong":
    #!/usr/bin/env bash
    set -euo pipefail
    if [ "{{CHAIN}}" = "mantradukong" ]; then
        VERIFIER_URL="https://evm.dukong.mantrachain.io/api"
    else
        VERIFIER_URL="https://evm.mantrachain.io/api"
    fi
    echo "üîç Verifying contract on {{CHAIN}}..."
    forge verify-contract {{CONTRACT_ADDRESS}} \
        contracts/Claimdrop.sol:Claimdrop \
        --verifier-url $VERIFIER_URL \
        --watch
    echo "‚úÖ Verification complete!"

# Create campaign on local Anvil (requires .env with campaign parameters)
create-campaign-local:
    @echo "üìã Creating campaign on local Anvil..."
    @forge script script/CreateCampaign.s.sol:CreateCampaign --rpc-url http://localhost:8545 --broadcast

# Create campaign on testnet (requires .env with campaign parameters)
create-campaign-testnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "üìã Creating campaign on MANTRA Dukong testnet..."
    forge script script/CreateCampaign.s.sol:CreateCampaign \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Campaign created!"

# Create campaign on mainnet (requires .env with campaign parameters)
create-campaign-mainnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Creating campaign on MAINNET - please confirm"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Campaign creation cancelled"
        exit 1
    fi
    echo "üìã Creating campaign on MANTRA mainnet..."
    forge script script/CreateCampaign.s.sol:CreateCampaign \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Campaign created!"

# Upload allocations to local Anvil (requires .env with CLAIMDROP_ADDRESS and ALLOCATIONS_FILE)
upload-allocations-local:
    @echo "üì§ Uploading allocations to local Anvil..."
    @forge script script/UploadAllocations.s.sol:UploadAllocations --rpc-url http://localhost:8545 --broadcast

# Upload allocations to testnet (requires .env with CLAIMDROP_ADDRESS and ALLOCATIONS_FILE)
upload-allocations-testnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_DUKONG_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_DUKONG_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "üì§ Uploading allocations to MANTRA Dukong testnet..."
    forge script script/UploadAllocations.s.sol:UploadAllocations \
        --rpc-url $MANTRA_DUKONG_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Allocations uploaded!"

# Upload allocations to mainnet (requires .env with CLAIMDROP_ADDRESS and ALLOCATIONS_FILE)
upload-allocations-mainnet:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "${MANTRA_MAINNET_RPC_URL:-}" ]; then
        echo "‚ùå Error: MANTRA_MAINNET_RPC_URL not set"
        exit 1
    fi
    if [ -z "${PRIVATE_KEY:-}" ]; then
        echo "‚ùå Error: PRIVATE_KEY not set"
        exit 1
    fi
    echo "‚ö†Ô∏è  Uploading allocations to MAINNET - please confirm"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Allocation upload cancelled"
        exit 1
    fi
    echo "üì§ Uploading allocations to MANTRA mainnet..."
    forge script script/UploadAllocations.s.sol:UploadAllocations \
        --rpc-url $MANTRA_MAINNET_RPC_URL \
        --private-key $PRIVATE_KEY \
        --broadcast
    echo "‚úÖ Allocations uploaded!"

# Run CI pipeline (format-check + lint + test-all)
ci:
    @echo "üöÄ Running CI pipeline..."
    @just format-check
    @just test-all
    @echo "‚úÖ CI pipeline complete!"
